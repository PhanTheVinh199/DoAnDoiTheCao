@include('partials.header')

<main id="main" class="main">
    <div class="section-gap">
        <div class="container">
            <div class="mb-3">
                <div class="text-center title">
                    ĐỔI THẺ CÀO SANG TIỀN MẶT
                </div>
                <style type="text/css">
                    .blinking-text {
                        font-weight: bold;
                        color: #e74c3c;
                        animation: blinker 1s linear infinite;
                    }

                    @keyframes blinker {
                        50% {
                            opacity: 0;
                        }
                    }
                </style>
                <p style="text-align: center;"><span style="color:#27ae60;"><cite><em>"Các shop api&nbsp;có sảnlượng
                                ổn định từ <strong>1.000.000d/ngày</strong> liên hệ để được hỗ trợ giá <strong>Đại
                                    Lý</strong>"</em> </cite> </span></p>
                <hr>
                <div class="notification">
                    <div class="notification-content">
                        <div class="text-center title"
                            style="font-size: 22px; margin-bottom: 10px; font-weight: 700; font-family: Roboto, Arial, Helvetica, sans-serif;">
                            <span style="color: rgb(17, 17, 17);">Đổi Thẻ Cào Thành Tiền Mặt Chiết Khấu Thấp Nhất
                                Thị Trường | Web Đổi Thẻ Cào Sang Tiền Mặt Uy Tín</span>
                            <font color="#000000">Tự Động 24/24</font>
                        </div>
                        <p><span
                                style="font-weight: bolder; color: rgb(211, 84, 0); font-family: Roboto, Arial, Helvetica, sans-serif; font-size: 14px;">✪&nbsp;</span><span
                                style="padding: 0px; margin: 0px; outline: 0px; font-weight: bolder; border: 0px; color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">Đổi
                                thẻ điện thoại sang tiền mặt</span><span
                                style="color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">&nbsp;(</span><em
                                style="padding: 0px; margin: 0px; outline: 0px; border: 0px; color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">Viettel,
                                Vinaphone, Mobifone, Vietnamobi,...</em><span
                                style="color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">)</span>
                        </p>
                        <p><span
                                style="color: rgb(211, 84, 0); font-family: Roboto, Arial, Helvetica, sans-serif; font-size: 14px; font-weight: 700;">✪&nbsp;</span><span
                                style="color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;"></span><span
                                style="padding: 0px; margin: 0px; outline: 0px; font-weight: bolder; border: 0px; color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">Đổi
                                thẻ Game thành tiền mặt</span><span
                                style="color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">&nbsp;(</span><em
                                style="padding: 0px; margin: 0px; outline: 0px; border: 0px; color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">Card
                                game zing, Vcoin, Gate, Garena, Appota</em><span
                                style="color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;">,Scoin..)</span>
                        </p>
                        <p><span
                                style="color: rgb(211, 84, 0); font-family: Roboto, Arial, Helvetica, sans-serif; font-size: 14px; font-weight: 700;">✪&nbsp;</span><span
                                style="color: rgb(0, 0, 0); font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 14px;"></span><span
                                style="padding: 0px; margin: 0px; outline: 0px; border: 0px; font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 19.6px; color: rgb(0, 0, 0);"><span
                                    style="padding: 0px; margin: 0px; outline: 0px; border: 0px; font-size: 14px;">Đổi
                                    thẻ cào, thẻ game sang MOMO / ATM/ Chiết khấu thấp,&nbsp;</span></span><span
                                style="padding: 0px; margin: 0px; outline: 0px; border: 0px; font-family: Tahoma, sans-serif, arial, Helvetica; font-size: 19.6px; color: rgb(51, 0, 204);"><span
                                    style="padding: 0px; margin: 0px; outline: 0px; border: 0px; font-size: 14px;"><span
                                        style="padding: 0px; margin: 0px; outline: 0px; font-weight: bolder; border: 0px;">nhận
                                        tiền ngay trong 5 giây</span></span></span></p>
                        <p style="font-size: 14px; line-height: 21px;"open="" sans";"=""><img alt=""
                                src="public/images/new.gif"
                                style="color: rgb(35, 35, 35); font-family: Roboto, Arial, Helvetica, sans-serif; height: 13px; width: 26px;"><span
                                style="line-height: 21px; font-weight: bolder; color: rgb(35, 35, 35); font-family: Roboto, Arial, Helvetica, sans-serif;">&nbsp;Tự
                                động 100%, Tốc độ xử lý cực nhanh, Rút tiền tự động,&nbsp;Hỗ trợ 24/7</span></p>
                        <p style="font-size: 14px; line-height: 21px;" open="" sans";"=""><span
                                style="line-height: 21px; color: rgb(35, 35, 35); font-family: Roboto, Arial, Helvetica, sans-serif;">&nbsp;</span><img
                                alt="" src="public/images/new.gif"
                                style="color: rgb(35, 35, 35); font-family: Roboto, Arial, Helvetica, sans-serif; height: 13px; width: 26px;"><span
                                style="line-height: 21px; color: rgb(35, 35, 35); font-family: Roboto, Arial, Helvetica, sans-serif;">&nbsp;<span
                                    style="font-weight: bolder;">Không để giá ảo, Cam Kết nạp tự động 100% không
                                    nuôt thẻ như các web trung gian</span></span></p>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="tabs-m1 mt-5">
                    <ul class="nav nav-tabs mb-2">
                        {{-- <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#theoform">
                                Đổi thẻ cào
                            </a>
                        </li> --}}
                        {{-- <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#nhieuthe">
                                    Đổi nhiều thẻ
                                </a>
                            </li> --}}
                    </ul>
                    <div class="tab-content">
                        <div class="tab tab-pane fade active show" id="theoform">
                            <div class="form-m1">






                                {{-- Form doi the cao --}}
                                <form action="{{ route('doithecao.exchange') }}" method="POST">
                                    @csrf
                                    <div id="createRow">
                                        <div class="row-item row row5 rowmb3">
                                            <div class="col-lg-3 col-sm-12 col-12" id="theCao">
                                                <!-- Lấy danh sách nhà cung cấp từ controller -->
                                                <select class="form-control telco" name="telco[]" id="network"
                                                    data-row="1">
                                                    @foreach ($nhacungcap as $nc)
                                                        <option value="{{ $nc->id_nhacungcap }}">{{ $nc->ten }}
                                                        </option>
                                                    @endforeach
                                                </select>
                                            </div>
                                            <div class="col-lg-3 col-sm-6 col-12">
                                                <div class="position-relative form-icon form-icon_right">
                                                    <input type="text" class="form-control" name="code[]"
                                                        id="code" data-row="1" placeholder="Mã nạp" required>
                                                    <button type="button" class="copy-value form-button">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-sm-6 col-12">
                                                <div class="position-relative form-icon form-icon_right">
                                                    <input type="text" class="form-control" name="serial[]"
                                                        data-row="1" id="seri" placeholder="Serial" required>
                                                    <button type="button" class="copy-value form-button">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-sm-10 col-9" id="menhGia">
                                                <!-- Lấy mệnh giá thẻ từ cơ sở dữ liệu -->
                                                <select class="form-control charging-amount" id="price"
                                                    name="amount[]" data-row="1" required>
                                                    <option value="">--- Mệnh giá ---</option>
                                                    @foreach ($menhgia as $mg)
                                                        <option value="{{ $mg->menh_gia }}">{{ $mg->menh_gia }} VND
                                                        </option>
                                                    @endforeach
                                                </select>
                                            </div>
                                            <div class="col-lg-1 col-sm-2 col-3 text-right">
                                                <button type="button" class="btn btn-small btn-success addRow">
                                                    <i class="fas fa-plus-circle"></i>
                                                    Thêm
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-2">
                                        <button type="submit" class="btn btn-theme_secondary btn-lg">
                                            <i class="fas fa-upload"></i>
                                            ĐỔI THẺ NGAY
                                        </button>
                                    </div>
                                </form>




                                {{-- Form doi the cao --}}







                            </div>
                        </div>
                        <div class="tab tab-pane fade" id="nhieuthe">
                            <div class="form-m1">
                                <form action="{{ route('doithecao.exchange') }}" method="POST">
                                    @csrf
                                    <div id="createRow">
                                        <div class="row-item row row5 rowmb3">
                                            <div class="col-lg-3 col-sm-12 col-12" id="theCao">
                                                <select class="form-control telco" name="telco[]" id="network"
                                                    data-row="1">
                                                    @foreach ($nhacungcap as $nc)
                                                        <option value="{{ $nc->id_nhacungcap }}">{{ $nc->ten }}
                                                        </option>
                                                    @endforeach
                                                </select>
                                            </div>
                                            <div class="col-lg-3 col-sm-6 col-12">
                                                <div class="position-relative form-icon form-icon_right">
                                                    <input type="number" class="form-control" name="code[]"
                                                        id="code" data-row="1" placeholder="Mã nạp" required>
                                                    <button type="button" class="copy-value form-button">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-sm-6 col-12">
                                                <div class="position-relative form-icon form-icon_right">
                                                    <input type="number" class="form-control" name="serial[]"
                                                        data-row="1" id="seri" placeholder="Serial" required>
                                                    <button type="button" class="copy-value form-button">
                                                        <i class="fas fa-paste"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-sm-10 col-9" id="menhGia">
                                                <select class="form-control charging-amount" id="price"
                                                    name="amount[]" data-row="1" required>
                                                    <option value="">--- Mệnh giá ---</option>
                                                    @foreach ($menhgia as $mg)
                                                        <option value="{{ $mg->menh_gia }}"
                                                            data-telco="{{ $mg->nhacungcap_id }}">{{ $mg->menh_gia }}
                                                            VND</option>
                                                    @endforeach
                                                </select>
                                            </div>
                                            <div class="col-lg-1 col-sm-2 col-3 text-right">
                                                <button type="button" class="btn btn-small btn-success addRow">
                                                    <i class="fas fa-plus-circle"></i>
                                                    Thêm
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-2">
                                        <button type="submit" class="btn btn-theme_secondary btn-lg">
                                            <i class="fas fa-upload"></i>
                                            ĐỔI THẺ NGAY
                                        </button>
                                    </div>
                                </form>


                            </div>
                        </div>
                    </div>

                    <div class="section-gap mt-5">
                        <div class="description mb-3">
                            <div class="text-center sub-title">
                                Bảng phí đổi thẻ cào
                            </div>
                        </div>
                        <div class="tabs-m1">
                            <ul class="nav nav-tabs">
                                @foreach ($nhacungcap as $nc)
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-{{ $nc->id_nhacungcap }}" data-toggle="tab"
                                            href="#nc-{{ $nc->id_nhacungcap }}">
                                            {{ $nc->ten }}
                                        </a>
                                    </li>
                                @endforeach
                            </ul>

                            <div class="tab-content">
                                @foreach ($nhacungcap as $nc)
                                    <div class="tab-pane fade" id="nc-{{ $nc->id_nhacungcap }}">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-striped table-module">
                                                <thead>
                                                    <tr>
                                                        <th class="text-nowrap text-center">Cấp bậc</th>
                                                        @foreach ($menhgia as $mg)
                                                            @if ($mg->nhacungcap_id == $nc->id_nhacungcap)
                                                                <th class="text-nowrap text-center"
                                                                    value="{{ $mg->menh_gia }}">{{ $mg->menh_gia }}
                                                                    VND</th>
                                                            @endif
                                                        @endforeach
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-xs-nowrap text-center font-weight-bold"
                                                            style="color:#0066ff;">
                                                            Thành viên
                                                        </td>
                                                        @foreach ($menhgia as $mg)
                                                            @if ($mg->nhacungcap_id == $nc->id_nhacungcap)
                                                                <td class="text-center text-success">
                                                                    {{ $mg->chiet_khau }}%</td>
                                                            @endif
                                                        @endforeach
                                                    </tr>
                                                </tbody>



                                            </table>
                                        </div>


                                    </div>
                                @endforeach

                                <div class="mt-4">
                                    <div class="description mb-3 mt-5">
                                        <div class="sub-title">
                                            Lịch sử đổi thẻ
                                        </div>
                                    </div>
                                    <div class="form-m1">
                                        <form action="#" name="formSearch" method="GET">
                                            <div class="row row5 rowmb3">
                                                <div class="col-lg col-md-3 col-6">
                                                    <form action="{{ route('index') }}" method="GET"
                                                        class="mb-4">
                                                        <div class="input-group">
                                                            <input type="text" name="search" class="form-control"
                                                                placeholder="Tìm kiếm mã đơn hoặc mã thẻ"
                                                                value="{{ request()->input('search') }}">
                                                            <button class="fal fa-search me-1  btn btn-primary" type="submit">Tìm
                                                                kiếm</button>
                                                        </div>
                                                    </form>
                                                </div>


                                               
                                            </div>
                                        </form>
                                    </div>

                                    <div class="table-responsive">
                                        <!-- Bảng lịch sử đơn hàng -->


                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th class="text-nowrap text-center">Mã Đơn</th>
                                                    <th class="text-nowrap text-center">Mã Thẻ</th>
                                                    <th class="text-nowrap text-center">Serial</th>
                                                    <th class="text-nowrap text-center">Mạng</th>
                                                    <th class="text-nowrap text-center">Mệnh Giá</th>
                                                    <th class="text-nowrap text-center">Phí</th>
                                                    <th class="text-nowrap text-center">Nhận</th>
                                                    <th class="text-nowrap text-center">Ngày Tháng</th>
                                                    <th class="text-nowrap text-center">Trạng Thái</th>
                                                </tr>
                                            </thead>

                                            <tbody>
                                                @foreach ($donhangs as $order)
                                                    <tr>
                                                        <td class="text-center">{{ $order->ma_don }}</td>
                                                        <td class="text-center">{{ $order->ma_the }}</td>
                                                        <td class="text-center">{{ $order->serial }}</td>
                                                        <td class="text-center">
                                                            <!-- If the product or supplier is missing, show N/A -->
                                                            {{ $order->doithecao && $order->doithecao->nhacungcap ? $order->doithecao->nhacungcap->ten : 'N/A' }}
                                                        </td>

                                                        <td class="text-center">
                                                            <!-- If the product is deleted or not available, show N/A -->
                                                            {{ $order->doithecao ? ($order->doithecao->menh_gia ? number_format($order->doithecao->menh_gia, 0, ',', '.') : 'N/A') : 'N/A' }}
                                                            VND
                                                        </td>

                                                        <td class="text-center">
                                                            <!-- If the product is deleted or not available, show N/A -->
                                                            {{ $order->doithecao ? number_format($order->doithecao->chiet_khau, 0, ',', '.') : 'N/A' }}%
                                                        </td>

                                                        <td class="text-center">
                                                            <!-- Display the amount or N/A if the product is deleted -->
                                                            {{ number_format($order->thanh_tien, 0, ',', '.') }} VND
                                                        </td>

                                                        <td class="text-center">{{ $order->ngay_tao }}</td>

                                                        <td class="text-center">
                                                            @if ($order->trang_thai == 'cho_xu_ly')
                                                                <button type="button" class="btn btn-warning">Chờ phê
                                                                    duyệt</button>
                                                            @elseif($order->trang_thai == 'da_huy')
                                                                <button type="button"
                                                                    class="btn btn-danger">Lỗi</button>
                                                            @elseif($order->trang_thai == 'hoat_dong')
                                                                <button type="button" class="btn btn-success">Thành
                                                                    Công</button>
                                                            @endif
                                                        </td>
                                                    </tr>
                                                @endforeach


                                                <!-- Nếu không có dữ liệu, hiển thị thông báo -->
                                                @if ($donhangs->isEmpty())
                                                    <tr>
                                                        <td colspan="9" class="text-center">Không có dữ liệu</td>
                                                    </tr>
                                                @endif
                                            </tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script type="text/javascript">
                    // Hiển thị bảng phí của nhà cung cấp khi nhấp vào tab
                    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
                        var target = $(e.target).attr("href"); // Lấy ID của tab được chọn
                        // Ẩn tất cả các bảng phí
                        $('.tab-pane').removeClass('active show');
                        // Hiển thị bảng phí của nhà cung cấp được chọn
                        $(target).addClass('active show');
                    });
                </script>

            </div>
        </div>
    </div>
    </div>


</main>
</body>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<!-- Bootstrap Bundle includes Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/javascript">
    // Cập nhật mệnh giá khi thay đổi nhà cung cấp
    $('#network').change(function() {
        var telco = $(this).val(); // Lấy giá trị nhà cung cấp được chọn
        var menhgiaSelect = $('#price');
        menhgiaSelect.empty().append('<option value="">--- Mệnh giá ---</option>'); // Clear các option cũ

        // Dữ liệu mệnh giá theo nhà cung cấp
        var menhgiaData = @json($menhgia);

        // Lọc mệnh giá theo nhà cung cấp
        var filteredMenhgia = menhgiaData.filter(function(item) {
            return item.nhacungcap_id == telco;
        });

        // Thêm các mệnh giá vào select
        filteredMenhgia.forEach(function(item) {
            menhgiaSelect.append('<option value="' + item.menh_gia + '">' + item.menh_gia +
                ' VND</option>');
        });
    });
</script>

<!-- Bao gồm SweetAlert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script type="text/javascript">
    // Kiểm tra nếu có thông báo thành công hoặc thất bại
    @if (session('success'))
        Swal.fire({
            icon: 'success',
            title: 'Thành công!',
            text: '{{ session('success') }}',
            showConfirmButton: true,
            timer: 5000
        });
    @endif

    @if (session('error'))
        Swal.fire({
            icon: 'error',
            title: 'Lỗi!',
            text: '{{ session('error') }}',
            showConfirmButton: true,
            timer: 5000
        });
    @endif

    // Kiểm tra khi người dùng nhập đúng thông tin
    $('form').submit(function(e) {
        e.preventDefault(); // Ngừng gửi form để kiểm tra trước

        let isValid = true;
        let serial = $('input[name="serial[]"]').val();
        let code = $('input[name="code[]"]').val();

        // Kiểm tra mã thẻ và serial có phải là số và dài từ 1 đến 30 ký tự không
        if (!/^\d{1,30}$/.test(serial) || !/^\d{1,30}$/.test(code)) {
            isValid = false;
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: 'Mã thẻ và serial phải là số và có từ 1 đến 30 ký tự!',
                showConfirmButton: true
            });
        }

        if (isValid) {
            // Nếu dữ liệu hợp lệ, yêu cầu xác nhận
            Swal.fire({
                title: 'Bạn có chắc chắn muốn tiếp tục?',
                text: "Hành động này sẽ không thể hoàn tác!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Gửi form nếu người dùng đồng ý
                    $('form')[0].submit();
                }
            });
        }
    });
</script>
</html>
@include('partials.footer')
